}
}
multiplot(c(q1+aes,q2+aes,q3+aes),col=1)
multiplot(q1+aes,q2+aes,q3+aes,col=1)
aes <- scale_colour_gradient(limits=c(0,200000),low="blue", high="red")
multiplot(q1+aes,q2+aes,q3+aes,col=1)
aes <- scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
multiplot(q1+aes,q2+aes,q3+aes,col=1)
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
multiplot(q0,q1+aes,q2+aes,q3+aes,col=2)
)
multiplot(q0,q1+aes,q2+aes,q3+aes,col=2)
######## Fundamental analysis ##########
str(receipt)
########################################################
## sales distribution by customer ######################
store_list <- c("s9111081","s6004012","s8904083")
## gain chart
for (i in 1:length(store_list)){
receipt %>%
filter(store == store_list[i]) %>%
filter(customer_code != "NA") %>%
group_by(customer_code,store) %>%
select(customer_code,store,qty_sales) %>%
summarise(sales = sum(qty_sales)) %>%
arrange(desc(sales))  -> tmp
assign(paste("cstm_data",store_list[i],sep="_"),tmp)
}
cstm_data <- list(cstm_data_s6004012,cstm_data_s8904083,cstm_data_s9111081)
## calculate cumulative sales% #################
for (k in 1:length(store_list)){
cstm_data[[k]]$dist <- cstm_data[[k]]$sales / sum(cstm_data[[k]]$sales)
for (i in 2:nrow(cstm_data[[k]])){
cstm_data[[k]]$cum_percent[1] = cstm_data[[k]]$dist[1]
cstm_data[[k]]$cum_percent[i] =  cstm_data[[k]]$cum_percent[i-1] +  cstm_data[[k]]$dis[i]
print(cstm_data[[k]]$cum_percent[i])
}
}
cstm_data
revenue <- rbind(cstm_data[[1]],cstm_data[[2]],cstm_data[[3]])
## dataset preparation end ######################
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014")
qplot(data=revenue,y=cum_percent,facets=store~.,colour=store,xlab="# of cust")
q1  <- qplot(data=cstm_data[[1]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q2  <- qplot(data=cstm_data[[2]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q3  <- qplot(data=cstm_data[[3]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
aes <- scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
multiplot(q0,q1+aes,q2+aes,q3+aes,col=2)
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
require(grid)
# Make a list from the ... arguments and plotlist
plots <- c(list(...), plotlist)
numPlots = length(plots)
# If layout is NULL, then use 'cols' to determine layout
if (is.null(layout)) {
# Make the panel
# ncol: Number of columns of plots
# nrow: Number of rows needed, calculated from # of cols
layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
ncol = cols, nrow = ceiling(numPlots/cols))
}
if (numPlots==1) {
print(plots[[1]])
} else {
# Set up the page
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
# Make each plot, in the correct location
for (i in 1:numPlots) {
# Get the i,j matrix positions of the regions that contain this subplot
matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
layout.pos.col = matchidx$col))
}
}
}
######## Fundamental analysis ##########
str(receipt)
########################################################
## sales distribution by customer ######################
store_list <- c("s9111081","s6004012","s8904083")
## gain chart
for (i in 1:length(store_list)){
receipt %>%
filter(store == store_list[i]) %>%
filter(customer_code != "NA") %>%
group_by(customer_code,store) %>%
select(customer_code,store,qty_sales) %>%
summarise(sales = sum(qty_sales)) %>%
arrange(desc(sales))  -> tmp
assign(paste("cstm_data",store_list[i],sep="_"),tmp)
}
cstm_data <- list(cstm_data_s6004012,cstm_data_s8904083,cstm_data_s9111081)
## calculate cumulative sales% #################
for (k in 1:length(store_list)){
cstm_data[[k]]$dist <- cstm_data[[k]]$sales / sum(cstm_data[[k]]$sales)
for (i in 2:nrow(cstm_data[[k]])){
cstm_data[[k]]$cum_percent[1] = cstm_data[[k]]$dist[1]
cstm_data[[k]]$cum_percent[i] =  cstm_data[[k]]$cum_percent[i-1] +  cstm_data[[k]]$dis[i]
print(cstm_data[[k]]$cum_percent[i])
}
}
cstm_data
revenue <- rbind(cstm_data[[1]],cstm_data[[2]],cstm_data[[3]])
## dataset preparation end ######################
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014")
qplot(data=revenue,y=cum_percent,facets=store~.,colour=store,xlab="# of cust")
q1  <- qplot(data=cstm_data[[1]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q2  <- qplot(data=cstm_data[[2]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q3  <- qplot(data=cstm_data[[3]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
aes <- scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
multiplot(q0,q1+aes,q2+aes,q3+aes,col=2)
receipt <- read.csv("C:/R_dir/DAC/src/fundamentals/receipt_sample.csv")
receipt <- tbl_df(receipt)
########################################################
## sales distribution by customer ######################
str(receipt)
########################################################
## 1.table preparation  ################################
store_list <- c("s9111081","s6004012","s8904083")
## create subset table(by store)
for (i in 1:length(store_list)){
receipt %>%
filter(store == store_list[i]) %>%
filter(customer_code != "NA") %>%
group_by(customer_code,store) %>%
select(customer_code,store,qty_sales) %>%
summarise(sales = sum(qty_sales)) %>%
arrange(desc(sales))  -> tmp
assign(paste("cstm_data",store_list[i],sep="_"),tmp)
}
cstm_data <- list(cstm_data_s6004012,cstm_data_s8904083,cstm_data_s9111081)
## calculate cumulative sales%
for (k in 1:length(store_list)){
cstm_data[[k]]$dist <- cstm_data[[k]]$sales / sum(cstm_data[[k]]$sales)
for (i in 2:nrow(cstm_data[[k]])){
cstm_data[[k]]$cum_percent[1] = cstm_data[[k]]$dist[1]
cstm_data[[k]]$cum_percent[i] =  cstm_data[[k]]$cum_percent[i-1] +  cstm_data[[k]]$dis[i]
print(cstm_data[[k]]$cum_percent[i])
}
}
cstm_data
revenue <- rbind(cstm_data[[1]],cstm_data[[2]],cstm_data[[3]])
## dataset preparation end ######################
########################################################################
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014")
qplot(data=revenue,y=cum_percent,facets=store~.,colour=store,xlab="# of cust")
q1  <- qplot(data=cstm_data[[1]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q2  <- qplot(data=cstm_data[[2]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q3  <- qplot(data=cstm_data[[3]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
aes <- scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
multiplot(q0,q1+aes,q2+aes,q3+aes,col=2)
multiplot(q0,q1+aes,q2+aes,q3+aes,col=1)
multiplot(q0,q1+aes,q2+aes,q3+aes,col=2)
multiplot(q0,q1+aes,q2+aes,q3+aes,cols=2)
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014",alpha=0.01)
multiplot(q0,q1+aes,q2+aes,q3+aes,cols=2)
receipt %>%
filter(customer_code != "NA") %>%
mutate(unique_prch = paste(yyyymmdd,store,regi_number,receipt_number,sep="_") ) %>%
group_by(customer_code,store) %>%
select(customer_code,store,qty_unit,qty_sales,unique_prch,qty_unit) %>%
summarise(sales=sum(qty_sales),freq=n_distinct(unique_prch),unit=sum(qty_unit)) %>%
arrange(desc(sales)) -> fm
fm %>%
mutate(unit_purchase=sales/freq) %>%
arrange(unit_purchase)
#######################################################################
## KPIs
fm %>% group_by(store) %>%
summarise(total_sales=sum(sales),num_cust=n_distinct(customer_code),
avg_sales=mean(sales),avg_freq=mean(freq),avg_unitPurchase=mean(sales/freq))-> kpi
kpi
kpi$store <- c("ktsk","sngw","ebts")
kpi$store <- factor(kpi$store,levels=c("sngw","ktsk","ebts"))
windows()
q <- qplot(data=kpi,x=store,stat="identity",fill=store)
q1 <- q + aes(y=num_cust)
q2 <- q + aes(y=total_sales)
q3 <- q + aes(y=avg_unitPurchase)
q4 <- q + aes(y=avg_freq)
multiplot(q2,q1,q3,q4,cols=2) # caution :: needs function definition
q <- qplot(data=fm,freq/5,sales/5,colour=sales/freq,xlim=c(0,25),ylim=c(0,25000),facets=store~.
,main="[freqency vs total_sales] per month (avg of Jan-June.2014)"
,xlab="# of purchase per month",ylab="total_purchase(yen) per month")
q + scale_colour_gradient(limits=c(0,1500),low="blue", high="red")
#Frew vs Sales (201401-07) plotting : monthly average
qplot(data=fm, sales/freq, geom="histogram", binwidth = 100,xlim=c(0,2500))
q <- qplot(data=fm,freq/5,sales/5,colour=sales/freq,xlim=c(0,25),ylim=c(0,25000),facets=store~.
,main="[freqency vs total_sales] per month (avg of Jan-June.2014)"
,xlab="# of purchase per month",ylab="total_purchase(yen) per month")
q + scale_colour_gradient(limits=c(0,1500),low="blue", high="red")
cust <- c("c9011181052180000","c9011181032000000")
receipt %>%
filter(customer_code==cust) %>%
select(yyyymmdd,customer_code,receipt_number,qty_unit,qty_sales,product) %>%
arrange(customer_code,yyyymmdd)
q + scale_colour_gradient(limits=c(0,1000),low="blue", high="red")
q <- qplot(data=fm,freq/5,sales/5,colour=sales/freq,xlim=c(0,25),ylim=c(0,25000),facets=store~.
,main="[freqency vs total_sales] per month (avg of Jan-June.2014)"
,xlab="# of purchase per month",ylab="total_purchase(yen) per month",
size=10,alpha=0.001)
q + scale_colour_gradient(limits=c(0,1500),low="blue", high="red")
q1 <- qplot(alpha=0.1,xlim=lim,ylim=lim,facets=store~.,size=10,
data = fm_ts, x=purchase01, y=purchase05, colour=purchase_ttl,
xlab="purchase amount in 2014.1 (yen)",ylab="purchase amount in 2014.5 (yen)",
main="monetary comparison : purchase_yen in 2014.01 vs 2014.05")
q1 +  scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
q1 +  scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
q1 <- qplot(alpha=0.1,xlim=lim,ylim=lim,facets=store~.,size=10,
data = fm_ts, x=purchase01, y=purchase05, colour=purchase_ttl,
xlab="purchase amount in 2014.1 (yen)",ylab="purchase amount in 2014.5 (yen)",
main="monetary comparison : purchase_yen in 2014.01 vs 2014.05")
q1 +  scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
###########################################################################
## Loyality growth/collapse
###########################################################################
## dataset preparation ###################################################
receipt %>%
filter(customer_code != "NA") %>%
mutate(unique_prch = paste(yyyymm,store,regi_number,receipt_number,sep="_") ) %>%
group_by(yyyymm,customer_code,store) %>%
select(yyyymm,customer_code,store,qty_unit,qty_sales,unique_prch,qty_unit) %>%
summarise(sales=sum(qty_sales),freq=n_distinct(unique_prch),unit=sum(qty_unit)) %>%
arrange(desc(sales)) -> fm
### dummy data to avoid NA
receipt %>%
filter(customer_code != "NA") %>%
group_by(customer_code,store) %>%
select(customer_code,store) %>%
mutate("201401"=0,"201402"=0,"201403"=0,"201404"=0,"201405"=0) -> tmp
fm_na.fill <- tbl_df( melt(data=tmp,id=c("store","customer_code")) )
fm_na.fill$freq <- 0 ; fm_na.fill$unit <- 0
fm_na.fill %>%
select(yyyymm=variable,customer_code,store,sales=value,freq,unit) -> fm_na.fill
# combilw with original data
fm <- rbind(fm,fm_na.fill)
fm %>%
group_by(yyyymm,customer_code,store) %>%
select(yyyymm,customer_code,store,sales,freq,unit) %>%
summarise(sales=sum(sales),"freq"=sum(freq),"unit"=sum(unit)) %>%
arrange(store,customer_code) -> fm
## end ##################################################################
## reshape (cross tabs)
fm_ts <- reshape(data = fm[,1:5], timevar="yyyymm",idvar=c("customer_code","store"),direction="wide")
fm_ts %>%
select(customer_code,store,
purchase01=sales.201401,
purchase02=sales.201402,
purchase03=sales.201403,
purchase04=sales.201404,
purchase05=sales.201405,
freq01=freq.201401,
freq02=freq.201402,
freq03=freq.201403,
freq04=freq.201404,
freq05=freq.201405) %>%
mutate(purchase_ttl=(purchase01+purchase02+purchase03+purchase04+purchase05),
freq_ttl=freq01+freq02+freq03+freq04+freq05) %>%
arrange(store) -> fm_ts
fm_ts
##################visualization ######################
## amount
lim=c(0,20000)
q1 <- qplot(alpha=0.1,xlim=lim,ylim=lim,facets=store~.,size=10,
data = fm_ts, x=purchase01, y=purchase05, colour=purchase_ttl,
xlab="purchase amount in 2014.1 (yen)",ylab="purchase amount in 2014.5 (yen)",
main="monetary comparison : purchase_yen in 2014.01 vs 2014.05")
q1 +  scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
## frequency
lim=c(0,40)
q2 <- qplot(alpha=0.001,xlim=lim,ylim=lim,facets=store~.,
data = fm_ts, x=freq01, y=freq05, colour=purchase_ttl,size=10,
xlab="purchase freq in 2014.1 (#)",ylab="purchase freq in 2014.5 (#)")
q2 +  scale_colour_gradient(limits=c(0,100000),low="blue", high="red")
fm_ts %>%
filter(freq01>=30)
fm
q3 <- qplot(yyyymmdd,sales)
q3
q3 <- qplot(data=fm,x=yyyymmdd,y=sales)
q3
qplot(data=fm,x=yyyymmdd,y=sales)
fm
qplot(data=fm,x=yyyymm,y=sales)
qplot(data=fm,x=yyyymm,y=sum(sales))
plot(data=fm,x=yyyymm)
plot(data=fm,x=yyyymm,y=sales)
fm %>% group_by(yyyymm,store) %>% summrise(freq)
fm %>% group_by(yyyymm,store) %>% summarise(freq)
fm %>% group_by(yyyymm,store) %>% summarise(freq) %<% select(yyyymm,store)
fm %>% group_by(yyyymm,store) %>% summarise(freq) %.% select(yyyymm,store)
fm %>% group_by(yyyymm,store) %>% summarise(freq) %>% select(yyyymm,store)
fm %>% group_by(yyyymm,store)%>% select(yyyymm,store,sales) %>% summarise(freq)
fm
fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,sales) %>% summarise(freq)
fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,sales) %>% summarise(sum(freq))
fm %>% group_by(yyyymm,store)  %>% summarise(sum(freq)) %>% select(yyyymm,store,freq)
fm %>% group_by(yyyymm,store)  %>% summarise(sum(freq)) %>% select(yyyymm,store)
fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,freq) %>% summarise(sum(freq))
plot(data=tmp,x=yyyymm,y=sum(freq),facets=store~.)
plot(data=tmp,x=yyyymm,y=sum(freq),facets=store~.)
qplot(data=tmp,x=yyyymm,y=sum(freq),facets=store~.)
tmp
tmp <- fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,freq) %>% summarise(sum(freq))
tmp
qplot(data=tmp,x=yyyymm,y=sum(freq),facets=store~.)
tmp <- fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,freq) %>% summarise(freq=sum(freq))
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.)
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="line")
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="lines")
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="line")
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="line")
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="bar")
tmp <- fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,freq) %>% summarise(freq=sum(freq))
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="bar")
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="line")
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,geom="line")
tmp
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.)
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=20)
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=50)
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=50,colour=I("red"),alpha=0.01)
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=1000,colour=I("red"),alpha=0.01)
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=10,colour=I("red"),alpha=0.01)
qplot(tmp$yyyymm,tmp$freq,facets=store~.,size=10,colour=I("red"),alpha=0.01)
qplot(tmp$yyyymm,tmp$freq,facets=tmp$store~.colour=I("red"))
qplot(tmp$yyyymm,tmp$freq,facets=tmp$store~.colour=I("red"))
qplot(tmp$yyyymm,tmp$freq,facets=tmp$store~.,colour=I("red"))
tmp$store
qplot(tmp$yyyymm,tmp$freq,facets=tmp$store~. ,colour=I("red"))
qplot(tmp$yyyymm,tmp$freq,facets=(tmp$store)~. ,colour=I("red"))
qplot(tmp$yyyymm,tmp$freq,facets=tmp$store~. ,colour=I("red"))
qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=50,colour=I("red"))
q3  <- qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=50,colour=I("red"))
multiplot(q2,q3,cols=2)
q2  <- q2 +  scale_colour_gradient(limits=c(0,100000),low="blue", high="red")
multiplot(q2,q3,cols=2)
tmp <- fm %>% group_by(yyyymm,store) %>% select(yyyymm,store,freq) %>% summarise(freq=mean(freq))
q3  <- qplot(data=tmp,x=yyyymm,y=freq,facets=store~.,size=50,colour=I("red"))
multiplot(q2,q3,cols=2)
tmp
fm_ts
receipt %>%
filter(customer_code != "NA") %>%
mutate(unique_prch = paste(yyyymm,store,regi_number,receipt_number,sep="_") ) %>%
group_by(yyyymm,customer_code,store) %>%
select(yyyymm,customer_code,store,qty_unit,qty_sales,unique_prch,qty_unit) %>%
summarise(sales=sum(qty_sales),freq=n_distinct(unique_prch),unit=sum(qty_unit)) %>%
arrange(desc(sales)) -> fm
fm
table(fm$yyyymm)
fm_ts <- reshape(data = fm[,1:5], timevar="yyyymm",idvar=c("customer_code","store"),direction="wide")
fm_ts
###########################################################################
## dataset preparation ###################################################
receipt %>%
filter(customer_code != "NA") %>%
mutate(unique_prch = paste(yyyymm,store,regi_number,receipt_number,sep="_") ) %>%
group_by(yyyymm,customer_code,store) %>%
select(yyyymm,customer_code,store,qty_unit,qty_sales,unique_prch,qty_unit) %>%
summarise(sales=sum(qty_sales),freq=n_distinct(unique_prch),unit=sum(qty_unit)) %>%
arrange(desc(sales)) -> fm
### dummy data to avoid NA
receipt %>%
filter(customer_code != "NA") %>%
group_by(customer_code,store) %>%
select(customer_code,store) %>%
mutate("201401"=0,"201402"=0,"201403"=0,"201404"=0,"201405"=0,"201406"=0) -> tmp
fm_na.fill <- tbl_df( melt(data=tmp,id=c("store","customer_code")) )
fm_na.fill$freq <- 0 ; fm_na.fill$unit <- 0
fm_na.fill %>%
select(yyyymm=variable,customer_code,store,sales=value,freq,unit) -> fm_na.fill
# combilw with original data
fm <- rbind(fm,fm_na.fill)
fm %>%
group_by(yyyymm,customer_code,store) %>%
select(yyyymm,customer_code,store,sales,freq,unit) %>%
summarise(sales=sum(sales),"freq"=sum(freq),"unit"=sum(unit)) %>%
arrange(store,customer_code) -> fm
## end ##################################################################
## reshape (cross tabs)
fm_ts <- reshape(data = fm[,1:5], timevar="yyyymm",idvar=c("customer_code","store"),direction="wide")
fm_ts %>%
select(customer_code,store,
purchase01=sales.201401,
purchase02=sales.201402,
purchase03=sales.201403,
purchase04=sales.201404,
purchase05=sales.201405,
purchase06=sales.201406,
freq01=freq.201401,
freq02=freq.201402,
freq03=freq.201403,
freq04=freq.201404,
freq05=freq.201405,
freq06=freq.201406) %>%
mutate(purchase_ttl=(purchase01+purchase02+purchase03+purchase04+purchase05+purchase06),
freq_ttl=freq01+freq02+freq03+freq04+freq05+freq06) %>%
arrange(store) -> fm_ts
fm_ts
## amount
lim=c(0,20000)
q1 <- qplot(alpha=0.1,xlim=lim,ylim=lim,facets=store~.,size=10,
data = fm_ts, x=purchase01, y=purchase06, colour=purchase_ttl,
xlab="purchase amount in 2014.1 (yen)",ylab="purchase amount in 2014.6 (yen)",
main="monetary comparison : purchase_yen in 2014.01 vs 2014.06")
q1 +  scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
q2 +  scale_colour_gradient(limits=c(0,100000),low="blue", high="red")
cust <- c("c9011181052180000","c9011181032000000")
receipt %>%
filter(customer_code==cust) %>%
select(yyyymmdd,customer_code,receipt_number,qty_unit,qty_sales,product) %>%
arrange(customer_code,yyyymmdd)
receipt %>%
filter(customer_code != "NA") %>%
mutate(unique_prch = paste(yyyymmdd,store,regi_number,receipt_number,sep="_") ) %>%
group_by(customer_code,store) %>%
select(customer_code,store,qty_unit,qty_sales,unique_prch,qty_unit) %>%
summarise(sales=sum(qty_sales),freq=n_distinct(unique_prch),unit=sum(qty_unit)) %>%
arrange(desc(sales)) -> fm
fm %>%
mutate(unit_purchase=sales/freq) %>%
arrange(unit_purchase)
#######################################################################
## KPIs
fm %>% group_by(store) %>%
summarise(total_sales=sum(sales),num_cust=n_distinct(customer_code),
avg_sales=mean(sales),avg_freq=mean(freq),avg_unitPurchase=mean(sales/freq))-> kpi
kpi
kpi$store <- c("ktsk","sngw","ebts")
kpi$store <- factor(kpi$store,levels=c("sngw","ktsk","ebts"))
windows()
q <- qplot(data=kpi,x=store,stat="identity",fill=store)
q1 <- q + aes(y=num_cust)
q2 <- q + aes(y=total_sales)
q3 <- q + aes(y=avg_unitPurchase)
q4 <- q + aes(y=avg_freq)
multiplot(q2,q1,q3,q4,cols=2) # caution :: needs function definition
########################################################################
## Frequency vs Sales (201401-06) plotting
windows()
q <- qplot(data=fm,freq/6,sales/6,colour=sales/freq,xlim=c(0,25),ylim=c(0,25000),facets=store~.
,main="[freqency vs total_sales] per month (avg of Jan-June.2014)"
,xlab="# of purchase per month",ylab="total_purchase(yen) per month",
size=10,alpha=0.001)
q + scale_colour_gradient(limits=c(0,1500),low="blue", high="red")
## sales distribution by customer ######################
str(receipt)
########################################################
## 1.table preparation  ################################
store_list <- c("s9111081","s6004012","s8904083")
## create subset table(by store)
for (i in 1:length(store_list)){
receipt %>%
filter(store == store_list[i]) %>%
filter(customer_code != "NA") %>%
group_by(customer_code,store) %>%
select(customer_code,store,qty_sales) %>%
summarise(sales = sum(qty_sales)) %>%
arrange(desc(sales))  -> tmp
assign(paste("cstm_data",store_list[i],sep="_"),tmp)
}
cstm_data <- list(cstm_data_s6004012,cstm_data_s8904083,cstm_data_s9111081)
## calculate cumulative sales%
for (k in 1:length(store_list)){
cstm_data[[k]]$dist <- cstm_data[[k]]$sales / sum(cstm_data[[k]]$sales)
for (i in 2:nrow(cstm_data[[k]])){
cstm_data[[k]]$cum_percent[1] = cstm_data[[k]]$dist[1]
cstm_data[[k]]$cum_percent[i] =  cstm_data[[k]]$cum_percent[i-1] +  cstm_data[[k]]$dis[i]
print(cstm_data[[k]]$cum_percent[i])
}
}
cstm_data
revenue <- rbind(cstm_data[[1]],cstm_data[[2]],cstm_data[[3]])
## dataset preparation end ######################
########################################################################
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014",alpha=0.01)
q0
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014",alpha=0.01,binname="y")
q0
qplot(data=revenue,y=cum_percent,facets=store~.,colour=store,xlab="# of cust")
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014",alpha=0.01)
q1  <- qplot(data=cstm_data[[1]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q2  <- qplot(data=cstm_data[[2]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
q3  <- qplot(data=cstm_data[[3]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales)
aes <- scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
multiplot(q0,q1+aes,q2+aes,q3+aes,cols=2)
q0 <- qplot(x=store,data=revenue,geom="bar",fill=I("blue"),ylab="# of customer",
main="#customer by store in Jan-June,2014",alpha=0.01)
q1  <- qplot(data=cstm_data[[1]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales,main="ebts")
q2  <- qplot(data=cstm_data[[2]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales,main="ktsk")
q3  <- qplot(data=cstm_data[[3]],y=cum_percent,xlab="#cust" ,ylab="% in ttl_sales",colour=sales,main="sngw")
aes <- scale_colour_gradient(limits=c(0,50000),low="blue", high="red")
multiplot(q0,q1+aes,q2+aes,q3+aes,cols=2)
